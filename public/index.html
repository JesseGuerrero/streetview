<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Street View Inspector</title>
    <script src="https://js.arcgis.com/4.33/"></script>
    <style>
        html,
        body,
        #viewDiv {
          height: 100vh;
          width: 100vw;
          display: block;
        }
        .esri-attribution {
          display: none !important;
        }
        .esri-ui-top-left {
          display: none !important;
        }
        canvas {
          width: 100vw !important;
          height: 100vh !important;
          margin: 0;
          padding: 0;
          display: block;
        }
        body {
            margin: 0;
        }
        #coordOverlay {
          position: absolute;
          top: 40px;
          right: 10px;
          background-color: rgba(0, 0, 0, 0.7);
          color: white;
          padding: 8px 12px;
          font-family: monospace;
          font-size: 12px;
          border-radius: 4px;
          line-height: 1.5;
          white-space: pre;
          pointer-events: auto;
        }
        #saveButton {
          background-color: rgba(76, 175, 80, 0.9);
          color: white;
          border: none;
          padding: 4px 12px;
          margin-top: 8px;
          cursor: pointer;
          border-radius: 3px;
          font-family: monospace;
          font-size: 11px;
          display: block;
          margin-left: auto;
          margin-right: auto;
        }
        #saveButton:hover {
          background-color: rgba(76, 175, 80, 1);
        }
        #saveButton.hidden {
          display: none;
        }
    </style>
</head>
<body>
    <div id="viewDiv">
    </div>
<script>
require([
  "esri/WebScene",
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/IntegratedMesh3DTilesLayer",
  "esri/Camera",
  "esri/request",
  "esri/identity/IdentityManager",
  "esri/views/SceneView",
  "esri/layers/FeatureLayer",
  "esri/layers/GraphicsLayer",
  "esri/layers/SceneLayer",
  "esri/layers/TileLayer",
  "esri/core/Collection",
  "esri/geometry/geometryEngine"
], function (WebScene, esriMap, MapView, IntegratedMesh3DTilesLayer, Camera, esriRequest, IdentityManager, SceneView, FeatureLayer, GraphicsLayer, SceneLayer, TileLayer, Collection, geometryEngine) {
    async function initializeMap() {
        let view = new SceneView({
          container: "viewDiv",
          map: new esriMap(),
          center: [-98.4936, 29.426],
          zoom: 18,
          camera: {
            position: {
              x: -98.5080,
              y: 29.4250,
              z: 800
            },
            heading: 90,
            tilt: 65
          },
          environment: {
            weather: {
              type: "sunny",
              cloudCover: 0.2,
              precipitation: 0.0
            }
          }
        });
        const google3DTiles = new IntegratedMesh3DTilesLayer({
          url: "https://tile.googleapis.com/v1/3dtiles/root.json",
          title: "Google tiles",
          customParameters: {
            "key": "{{ google 3d tiles }}"
          }
        });
        view.map.add(google3DTiles)
        const footprints = new FeatureLayer({
          portalItem: {
            id: "0173d18b79d243f69d24ab94cb3d961b"
          },
          title: "Footprints",
          outFields: ["*"],
          popupEnabled: true,
          popupTemplate: {
            title: "{name}",
            content: [
                {
                    type: "fields",
                    fieldInfos: [
                        { fieldName: "Address", label: "Address" },
                        { fieldName: "Zip_Code", label: "Zip Code" },
                    ]
                }
            ],
            outFields: ["*"]
          },
          elevationInfo: {
            mode: "on-the-ground",
            offset: 0,
            unit: "meters"
          },
          renderer: {
            type: "simple",
            symbol: {
              type: "polygon-3d",
              symbolLayers: [
                {
                  type: "fill",
                  material: { color: [60, 60, 200, 0.4] }
                },
                {
                  type: "line",
                  material: { color: [0, 0, 0, 0.0] },
                  size: 4
                }
              ]
            }
          },
        })
        view.map.add(footprints)

        const streetViewWidget = document.createElement("div");
      streetViewWidget.id = "streetViewWidget";
      streetViewWidget.className = "esri-widget";
      streetViewWidget.style.position = "absolute";
      streetViewWidget.style.top = "180px";
      streetViewWidget.style.right = "20px";
      streetViewWidget.style.width = "500px";
      streetViewWidget.style.height = "500px";
      streetViewWidget.style.padding = "0";
      streetViewWidget.style.overflow = "hidden";
      streetViewWidget.style.display = "none";
      streetViewWidget.style.borderRadius = "8px";
      streetViewWidget.style.boxShadow = "0 2px 6px rgba(0,0,0,0.3)";

      const streetViewImage = document.createElement("img");
      streetViewImage.crossOrigin = "anonymous";
      streetViewImage.id = "streetViewImage";
      streetViewImage.style.width = "100%";
      streetViewImage.style.height = "calc(100% - 36px)";
      streetViewImage.alt = "Street View";
      streetViewWidget.appendChild(streetViewImage);

      const coordOverlay = document.createElement("div");
      coordOverlay.id = "coordOverlay";

      const coordText = document.createElement("div");
      coordText.id = "coordText";
      coordOverlay.appendChild(coordText);

      const cachedStatus = document.createElement("div");
      cachedStatus.id = "cachedStatus";
      cachedStatus.textContent = "Cached: No";
      coordOverlay.appendChild(cachedStatus);

      const saveButton = document.createElement("button");
      saveButton.id = "saveButton";
      saveButton.textContent = "Save";
      let currentCoords = { longitude: null, latitude: null, heading: null };

      async function checkIfCached(longitude, latitude, heading) {
          const response = await fetch('/check-nearby-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ longitude, latitude, heading })
          });

          const result = await response.json();
          return result;
        }

      saveButton.onclick = async function() {
          if (!currentCoords.longitude) return;

          // Convert image to base64
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = streetViewImage.naturalWidth;
          canvas.height = streetViewImage.naturalHeight;
          ctx.drawImage(streetViewImage, 0, 0);
          const imageData = canvas.toDataURL('image/jpeg');

          const response = await fetch('/save-street-view', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              ...currentCoords,
              image: imageData
            })
          });

          const result = await response.json();
          if (result.success) {
            cachedStatus.textContent = "Cached: Yes";
            saveButton.classList.add('hidden');
          }
        };
      coordOverlay.appendChild(saveButton);

      streetViewWidget.appendChild(coordOverlay);

      const style = document.createElement('style');
        style.textContent = `
          #streetViewWidget {
            position: relative;
          }

          #resizeHandle {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 15px;
            height: 15px;
            background-color: rgba(0, 0, 0, 0.5);
            cursor: nwse-resize;
            border-radius: 0 0 0 8px;
            z-index: 10;
          }
        `;
        document.head.appendChild(style);

        const resizeHandle = document.createElement('div');
        resizeHandle.id = 'resizeHandle';
        streetViewWidget.appendChild(resizeHandle);

        let isResizing = false;
        let originalWidth, originalHeight, originalPos, startX, startY;
        const viewDivElement = document.getElementById('viewDiv');

        resizeHandle.addEventListener('mousedown', function(e) {
          e.preventDefault();
          e.stopPropagation();

          isResizing = true;

          const viewDivRect = viewDivElement.getBoundingClientRect();
          const widgetRect = streetViewWidget.getBoundingClientRect();

          originalWidth = streetViewWidget.offsetWidth;
          originalHeight = streetViewWidget.offsetHeight;
          originalPos = {
            left: widgetRect.left - viewDivRect.left,
            top: widgetRect.top - viewDivRect.top
          };

          startX = e.clientX;
          startY = e.clientY;

          document.addEventListener('mousemove', resize);
          document.addEventListener('mouseup', stopResize);
        });

        function resize(e) {
          if (!isResizing) return;

          const widthChange = startX - e.clientX;
          const heightChange = e.clientY - startY;

          const newWidth = Math.max(150, originalWidth + widthChange);
          const newHeight = Math.max(150, originalHeight + heightChange);

          streetViewWidget.style.width = newWidth + 'px';
          streetViewWidget.style.height = newHeight + 'px';

          streetViewWidget.style.left = (originalPos.left - (newWidth - originalWidth)) + 'px';
        }

        function stopResize() {
          isResizing = false;
          document.removeEventListener('mousemove', resize);
          document.removeEventListener('mouseup', stopResize);
        }

        streetViewWidget.style.cursor = 'move';
        let isDragging = false;
        let offsetX, offsetY;

        streetViewWidget.addEventListener('mousedown', function(e) {
          if (e.target.id === 'resizeHandle' || e.target.tagName === 'BUTTON') {
            return;
          }

          isDragging = true;

          const viewDivRect = viewDivElement.getBoundingClientRect();
          const widgetRect = streetViewWidget.getBoundingClientRect();

          offsetX = e.clientX - widgetRect.left;
          offsetY = e.clientY - widgetRect.top;

          e.preventDefault();
        });

        document.addEventListener('mousemove', function(e) {
          if (!isDragging) return;

          const viewDivRect = viewDivElement.getBoundingClientRect();

          const newLeft = e.clientX - viewDivRect.left - offsetX;
          const newTop = e.clientY - viewDivRect.top - offsetY;

          const maxLeft = viewDivRect.width - streetViewWidget.offsetWidth;
          const maxTop = viewDivRect.height - streetViewWidget.offsetHeight;

          streetViewWidget.style.left = Math.max(0, Math.min(newLeft, maxLeft)) + 'px';
          streetViewWidget.style.top = Math.max(0, Math.min(newTop, maxTop)) + 'px';
        });

        document.addEventListener('mouseup', function() {
          isDragging = false;
        });

          const titleBar = document.createElement("div");
          titleBar.style.backgroundColor = "rgba(125,125,125,1.0)";
          titleBar.style.color = "white";
          titleBar.style.padding = "8px";
          titleBar.style.fontWeight = "bold";
          titleBar.style.display = "flex";
          titleBar.style.justifyContent = "space-between";
          titleBar.style.alignItems = "center";
          titleBar.style.marginTop = "-5px";
          titleBar.innerHTML = "<span>Street View</span>";

          const closeButton = document.createElement("button");
          closeButton.innerHTML = "X";
          closeButton.style.background = "none";
          closeButton.style.border = "none";
          closeButton.style.border = "none";
          closeButton.style.color = "white";
          closeButton.style.fontSize = "20px";
          closeButton.style.cursor = "pointer";
          closeButton.style.padding = "0 5px";
          closeButton.onclick = function() {
              streetViewWidget.style.display = "none";
          };
          titleBar.appendChild(closeButton);
          streetViewWidget.appendChild(titleBar);

        view.ui.add(streetViewWidget, "manual");

        view.on("double-click", async (event) => {
          event.stopPropagation();

          view.hitTest(event).then(async (response) => {
            const latitude = event.mapPoint.latitude;
            const longitude = event.mapPoint.longitude;
            const currentHeading = view.camera.heading;

            coordText.textContent = `lon: ${longitude.toFixed(6)}\nlat: ${latitude.toFixed(6)}\nheading: ${currentHeading.toFixed(2)}`;

            currentCoords = {
              longitude: longitude.toFixed(6),
              latitude: latitude.toFixed(6),
              heading: currentHeading.toFixed(2)
            };

            // Check if this location is already cached
            const cacheResult = await checkIfCached(
              currentCoords.longitude,
              currentCoords.latitude,
              currentCoords.heading
            );

            if (cacheResult.cached) {
              cachedStatus.textContent = "Cached: Yes";
              saveButton.classList.add('hidden');
            } else {
              cachedStatus.textContent = "Cached: No";
              saveButton.classList.remove('hidden');
            }

            const streetViewUrl = `https://maps.googleapis.com/maps/api/streetview?size=900x900&location=${latitude},${longitude}&fov=80&heading=${currentHeading}&pitch=0&key={{ google street view }}`;
            streetViewImage.src = streetViewUrl;

            streetViewWidget.style.display = "block";
          });
      });
    }
    initializeMap()
});

</script>
</body>
</html>